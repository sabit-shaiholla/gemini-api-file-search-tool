name: Deploy to Oracle Cloud

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Static analysis (py_compile)
        run: |
          python -m py_compile $(git ls-files '*.py')

      - name: Deploy to Oracle Cloud
        uses: appleboy/ssh-action@v1.0.3
        env:
          TARGET_BRANCH: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
          REMOTE_APP_DIR: ${{ vars.ORACLE_APP_DIR }}
          REMOTE_SERVICE: ${{ vars.ORACLE_SERVICE_NAME }}
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USERNAME }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: ${{ secrets.ORACLE_SSH_PORT || '22' }}
          script: |
            set -euo pipefail

            APP_DIR="${REMOTE_APP_DIR:-$HOME/gemini-api-file-search-tool}"
            SERVICE_NAME="${REMOTE_SERVICE:-streamlit}"
            BRANCH="${TARGET_BRANCH:-main}"

            if [ ! -d "$APP_DIR/.git" ]; then
              git clone "https://github.com/${REPO}" "$APP_DIR"
            fi

            cd "$APP_DIR"

            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git reset --hard "origin/$BRANCH"

            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
            fi

            source .venv/bin/activate
            python -m pip install --upgrade pip
            pip install -r requirements.txt

            sudo systemctl restart "$SERVICE_NAME"
            sudo systemctl status "$SERVICE_NAME" --no-pager

            echo "Deployment completed successfully!"